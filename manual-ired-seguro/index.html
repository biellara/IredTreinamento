<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Suporte | IRED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-red: #b91c1c;
            --brand-red-dark: #991b1b;
            --brand-red-light: #fecaca;
            --sidebar-bg: #1f2937;
            --main-bg: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            color: #d1d5db;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-link:hover {
            background-color: #374151;
            color: white;
        }
        .sidebar-link.active {
            background-color: var(--brand-red);
            color: white;
            font-weight: 600;
        }
        .sidebar-link svg {
            margin-right: 0.75rem;
            width: 1.25rem;
            height: 1.25rem;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .main-content-area {
            display: none;
        }
        .main-content-area.active {
            display: block;
        }
        .prose h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--brand-red);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #fee2e2;
        }
        .prose strong { color: #7f1d1d; }
        .prose ul { padding-left: 1.25rem; list-style-type: disc; }
        .prose li { margin-bottom: 0.5rem; }

        /* Estilos do Gerador de Relat√≥rio e outros modais adaptados */
        #report-output {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            white-space: pre-wrap;
        }

        /* Anima√ß√£o de fade-in para as views */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .main-content-area.active {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-gray-800 p-4 flex flex-col">
            <div class="flex items-center gap-3 mb-8 px-2">
                <img src="https://i.ibb.co/fVwtcjjz/IRED-internet-VERMELHO.png" alt="Logo da IRED" class="h-10 w-10 bg-white p-1 rounded-full" onerror="this.style.display='none'">
                <span class="text-white text-xl font-bold">Suporte IRED</span>
            </div>
            <nav class="flex-grow space-y-2">
                <a href="#" class="sidebar-link active" data-target="inicio-view">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    In√≠cio
                </a>

                <div>
                    <h3 class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">Ferramentas IA</h3>
                    <a href="#" class="sidebar-link" data-target="diagnostico-view">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        Diagn√≥stico
                    </a>
                    <a href="#" class="sidebar-link" data-target="simulador-view">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z"/><path d="M17 15.54c-1.53-1.4-3.5-2.5-5.5-2.5s-4 1.1-5.5 2.5"/><path d="M8 10c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5-1.5.67-1.5 1.5Z"/><path d="M14.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5Z"/></svg>
                        Simulador
                    </a>
                     <a href="#" class="sidebar-link" data-target="relatorio-view">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/></svg>
                        Gerar Relat√≥rio
                    </a>
                </div>

                 <div>
                    <h3 class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2">Base de Conhecimento</h3>
                     <a href="#" class="sidebar-link" data-target="conhecimento-view">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        Manual T√©cnico
                    </a>
                </div>

            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            
            <!-- View: In√≠cio -->
            <div id="inicio-view" class="main-content-area active">
                <h1 class="text-4xl font-extrabold text-gray-800">Bem-vindo ao Dashboard de Suporte IRED</h1>
                <p class="text-xl text-gray-600 mt-2">Suas ferramentas de IA para um atendimento de excel√™ncia est√£o a um clique de dist√¢ncia.</p>

                <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <a href="#" data-target="diagnostico-view" class="card p-6 block nav-card">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-red-100 rounded-lg"><svg class="h-8 w-8 text-red-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Diagn√≥stico Inteligente</h2>
                                <p class="text-gray-500 mt-1">Gere checklists e scripts de atendimento.</p>
                            </div>
                        </div>
                    </a>
                     <a href="#" data-target="simulador-view" class="card p-6 block nav-card">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-blue-100 rounded-lg"><svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z"/><path d="M17 15.54c-1.53-1.4-3.5-2.5-5.5-2.5s-4 1.1-5.5 2.5"/><path d="M8 10c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5-1.5.67-1.5 1.5Z"/><path d="M14.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5Z"/></svg></div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Simulador de Atendimento</h2>
                                <p class="text-gray-500 mt-1">Pratique chamadas com um cliente-rob√¥.</p>
                            </div>
                        </div>
                    </a>
                     <a href="#" data-target="relatorio-view" class="card p-6 block nav-card">
                        <div class="flex items-center gap-4">
                            <div class="p-3 bg-green-100 rounded-lg"><svg class="h-8 w-8 text-green-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4Z"/></svg></div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Gerador de Relat√≥rios</h2>
                                <p class="text-gray-500 mt-1">Automatize a cria√ß√£o de tickets t√©cnicos.</p>
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- View: Diagn√≥stico -->
            <div id="diagnostico-view" class="main-content-area">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">‚ú® Diagn√≥stico Inteligente</h1>
                <div class="card p-8">
                     <label for="problemDescription" class="block text-gray-700 font-semibold mb-2">Descreva o problema relatado pelo cliente:</label>
                    <textarea id="problemDescription" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500" placeholder="Ex: 'Minha internet est√° caindo toda hora na TV quando tento assistir Netflix. No celular parece normal.'"></textarea>
                    <button id="analyzeBtn" class="mt-4 w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors disabled:bg-red-300">Analisar Problema</button>
                    <div id="ai-loader" class="text-center mt-6">
                        <svg class="animate-spin h-8 w-8 text-red-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="text-gray-600 mt-2">Analisando... Por favor, aguarde.</p>
                    </div>
                    <div id="ai-results" class="hidden mt-6 space-y-6">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">üìã Diagn√≥stico Sugerido:</h3>
                            <div id="diagnosis-output" class="prose mt-2 text-gray-700 p-4 bg-gray-50 rounded-lg border"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">üí¨ Script de Atendimento Sugerido:</h3>
                            <div id="script-output" class="prose mt-2 text-gray-700 bg-red-50 p-4 rounded-lg border border-red-200"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Simulador -->
            <div id="simulador-view" class="main-content-area">
                <div id="sim-setup-view">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">üí¨ Simulador de Atendimento</h1>
                    <div class="card p-8">
                        <label for="scenarioSelect" class="block text-gray-700 font-semibold mb-2">Escolha um cen√°rio para praticar:</label>
                        <select id="scenarioSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="lentidao-frustrado">Cliente frustrado com lentid√£o</option>
                            <option value="wifi-nao-funciona-leigo">Cliente leigo com Wi-Fi que "n√£o funciona no quarto"</option>
                            <option value="quedas-constantes-irritado">Cliente irritado com quedas constantes de conex√£o</option>
                            <option value="velocidade-baixa-cabo">Cliente com velocidade baixa no computador (via cabo)</option>
                        </select>
                        <button id="startSimBtn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Iniciar Simula√ß√£o</button>
                    </div>
                </div>

                <div id="sim-chat-view" class="hidden flex flex-col h-[80vh]">
                     <h1 class="text-3xl font-bold text-gray-800 mb-4">Simula√ß√£o em Andamento...</h1>
                     <div class="card p-4 flex-1 flex flex-col">
                        <div id="chat-history" class="flex-1 mb-4"></div>
                        <div id="sim-loader" class="text-center my-2">
                             <p class="text-gray-500 italic">Cliente-rob√¥ est√° digitando...</p>
                        </div>
                        <div class="mt-auto flex gap-2">
                            <input type="text" id="chat-input" class="w-full p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500" placeholder="Digite sua resposta...">
                            <button id="sendChatBtn" class="p-3 rounded-full bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.028 16.5l-4.243-3.03a1 1 0 01.125-1.688l11-4a1 1 0 011.083.93l-1.429 5a1 1 0 001.905.544l7-14a1 1 0 00-1.409-1.169z" /></svg>
                            </button>
                        </div>
                     </div>
                     <button id="endSimBtn" class="mt-4 w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Finalizar e Pedir Feedback</button>
                </div>

                <div id="sim-feedback-view" class="hidden">
                     <h1 class="text-3xl font-bold text-gray-800 mb-6">‚≠ê Avalia√ß√£o do Atendimento</h1>
                     <div class="card p-8">
                         <div id="feedback-results" class="prose max-w-none"></div>
                         <button id="restartSimBtn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Iniciar Nova Simula√ß√£o</button>
                    </div>
                </div>
            </div>
            
            <!-- View: Relat√≥rio -->
            <div id="relatorio-view" class="main-content-area">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">üìù Gerador de Relat√≥rio P√≥s-Atendimento</h1>
                <div class="card p-8">
                    <label for="reportSummary" class="block text-gray-700 font-semibold mb-2">Escreva um resumo simples do atendimento:</label>
                    <textarea id="reportSummary" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Ex: cliente com lentid√£o na netflix, alterado canal do wi-fi para 11, problema resolvido."></textarea>
                    
                    <button id="generateReportBtn" class="mt-4 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-green-300">Gerar Relat√≥rio T√©cnico</button>
                    
                    <div id="report-loader" class="text-center mt-6">
                        <svg class="animate-spin h-8 w-8 text-green-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p class="text-gray-600 mt-2">Criando relat√≥rio formal... Aguarde.</p>
                    </div>
                    
                    <div id="report-results" class="hidden mt-6">
                        <h3 class="font-bold text-lg text-gray-800">Relat√≥rio Gerado:</h3>
                        <textarea id="report-output" rows="10" class="prose mt-2 w-full text-gray-700 p-3 bg-gray-50 rounded-lg border" readonly></textarea>
                        <button id="copyReportBtn" class="mt-2 w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors">
                            <span class="flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H4z" /></svg>
                                <span id="copyBtnText">Copiar Relat√≥rio</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- View: Conhecimento -->
            <div id="conhecimento-view" class="main-content-area">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">üìö Base de Conhecimento</h1>
                <div id="manual-content" class="prose max-w-none space-y-8">
                    <!-- O conte√∫do dos slides ser√° injetado aqui pelo JavaScript -->
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Navigation ---
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const navCards = document.querySelectorAll('.nav-card');
            const views = document.querySelectorAll('.main-content-area');

            function switchView(targetId) {
                views.forEach(view => {
                    view.classList.toggle('active', view.id === targetId);
                });
                sidebarLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.target === targetId);
                });
            }

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(link.dataset.target);
                });
            });
            
             navCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(card.dataset.target);
                });
            });

            // --- AI Tools Logic (Adapta√ß√£o dos modais) ---

            // Diagn√≥stico
            const analyzeBtn = document.getElementById('analyzeBtn');
            const problemDescription = document.getElementById('problemDescription');
            const aiLoader = document.getElementById('ai-loader');
            const aiResults = document.getElementById('ai-results');
            const diagnosisOutput = document.getElementById('diagnosis-output');
            const scriptOutput = document.getElementById('script-output');
            
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', async () => {
                    if (!problemDescription.value.trim()) { problemDescription.focus(); return; }
                    aiLoader.style.display = 'block';
                    aiResults.classList.add('hidden');
                    analyzeBtn.disabled = true;
                    try {
                        const diagnosisPrompt = `Voc√™ √© um assistente especialista para um atendente de suporte t√©cnico de um provedor de internet chamado IRED. Sua tarefa √© analisar a descri√ß√£o do problema de um cliente e, com base no Manual T√©cnico da IRED, sugerir um checklist estruturado de passos de verifica√ß√£o. O manual cobre: 1. Diagn√≥stico de Conex√£o (status do sistema, falhas massivas, n√≠veis de sinal), 2. Diagn√≥stico de Lentid√£o (testes de velocidade, categoria de cabo, bandas Wi-Fi), 3. Diagn√≥stico de Cobertura Wi-Fi (for√ßa do sinal, interfer√™ncias). Com base no seguinte problema do cliente, forne√ßa a causa prov√°vel e um checklist curto e priorizado do que o atendente deve investigar. Formate a resposta de forma clara, com t√≥picos e usando Markdown para negrito. Problema do cliente: "${problemDescription.value}"`;
                        const diagnosis = await callGemini(diagnosisPrompt);
                        diagnosisOutput.innerHTML = parseSimpleMarkdown(diagnosis);
                        
                        const scriptPrompt = `Com base no seguinte diagn√≥stico e problema do cliente, gere um script de atendimento curto, emp√°tico e claro para o atendente de suporte usar para iniciar a solu√ß√£o do problema. O tom deve ser profissional e prestativo. Use Markdown para negrito para destacar termos importantes. Diagn√≥stico: "${diagnosis}". Problema do cliente: "${problemDescription.value}"`;
                        const script = await callGemini(scriptPrompt);
                        scriptOutput.innerHTML = parseSimpleMarkdown(script);
                        aiResults.classList.remove('hidden');
                    } catch (error) {
                        console.error('Error calling Gemini API:', error);
                        diagnosisOutput.innerHTML = 'Ocorreu um erro ao analisar o problema. Por favor, tente novamente.';
                        scriptOutput.innerHTML = '';
                        aiResults.classList.remove('hidden');
                    } finally {
                        aiLoader.style.display = 'none';
                        analyzeBtn.disabled = false;
                    }
                });
            }

            // Simulador
            const simSetupView = document.getElementById('sim-setup-view');
            const simChatView = document.getElementById('sim-chat-view');
            const simFeedbackView = document.getElementById('sim-feedback-view');
            const scenarioSelect = document.getElementById('scenarioSelect');
            const startSimBtn = document.getElementById('startSimBtn');
            const chatHistoryEl = document.getElementById('chat-history');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const endSimBtn = document.getElementById('endSimBtn');
            const simLoader = document.getElementById('sim-loader');
            const feedbackResults = document.getElementById('feedback-results');
            const restartSimBtn = document.getElementById('restartSimBtn');
            let conversationHistory = [];
            const scenarios = {
                'lentidao-frustrado': "Voc√™ √© um cliente chamado Carlos. Voc√™ est√° muito frustrado porque sua internet est√° lenta h√° dias, especialmente √† noite quando tenta ver filmes. Seja impaciente e um pouco irritado.",
                'wifi-nao-funciona-leigo': "Voc√™ √© uma cliente chamada Maria. Voc√™ n√£o entende muito de tecnologia. Sua queixa √© que o 'sinal do wi-fi n√£o chega no seu quarto', que fica no segundo andar. Seja um pouco confusa mas simp√°tica.",
                'quedas-constantes-irritado': "Voc√™ √© um cliente chamado Jo√£o. Sua internet cai o tempo todo, v√°rias vezes por hora, atrapalhando seu trabalho home office. Voc√™ est√° muito irritado e amea√ßa cancelar o plano.",
                'velocidade-baixa-cabo': "Voc√™ √© uma cliente chamada Sandra. Voc√™ contratou um plano de 500 Mega, mas quando testa a velocidade no seu computador de mesa (conectado via cabo) nunca passa de 95 Mega. Voc√™ est√° desconfiada que est√° sendo enganada."
            };

            function appendMessage(text, sender) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', sender);
                bubble.innerHTML = parseSimpleMarkdown(text);
                chatHistoryEl.appendChild(bubble);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            }

            async function startSimulation() {
                simSetupView.style.display = 'none';
                simChatView.style.display = 'flex';
                simFeedbackView.style.display = 'none';
                chatHistoryEl.innerHTML = '';
                conversationHistory = [];
                simLoader.style.display = 'block';
                chatInput.disabled = true;
                sendChatBtn.disabled = true;
                const selectedScenario = scenarioSelect.value;
                const systemPrompt = `Vamos simular um atendimento de suporte t√©cnico. Voc√™ √© o CLIENTE. Eu serei o ATENDENTE. Siga estritamente a personalidade e o problema a seguir. N√£o revele que voc√™ √© uma IA. Comece a conversa com sua primeira reclama√ß√£o.\n\nSEU PERFIL: ${scenarios[selectedScenario]}`;
                conversationHistory.push({ role: 'user', parts: [{ text: systemPrompt }] });
                try {
                    const firstResponse = await callGeminiWithHistory(conversationHistory);
                    conversationHistory.push({ role: 'model', parts: [{ text: firstResponse }] });
                    appendMessage(firstResponse, 'customer');
                } catch (error) {
                    console.error("Error starting simulation:", error);
                    appendMessage("Desculpe, houve um erro ao iniciar a simula√ß√£o. Tente novamente.", 'customer');
                } finally {
                    simLoader.style.display = 'none';
                    chatInput.disabled = false;
                    sendChatBtn.disabled = false;
                    chatInput.focus();
                }
            }
            
            async function sendChatMessage() {
                const messageText = chatInput.value.trim();
                if (!messageText) return;
                appendMessage(messageText, 'attendant');
                conversationHistory.push({ role: 'user', parts: [{ text: messageText }] });
                chatInput.value = '';
                simLoader.style.display = 'block';
                chatInput.disabled = true;
                sendChatBtn.disabled = true;
                try {
                    const customerResponse = await callGeminiWithHistory(conversationHistory);
                    conversationHistory.push({ role: 'model', parts: [{ text: customerResponse }] });
                    appendMessage(customerResponse, 'customer');
                } catch (error) {
                    console.error("Error getting customer response:", error);
                    appendMessage("Ocorreu um erro. Por favor, tente responder novamente ou finalize a simula√ß√£o.", 'customer');
                } finally {
                     simLoader.style.display = 'none';
                    chatInput.disabled = false;
                    sendChatBtn.disabled = false;
                    chatInput.focus();
                }
            }

            async function endSimulation() {
                simLoader.style.display = 'block';
                chatInput.disabled = true;
                sendChatBtn.disabled = true;
                const feedbackPrompt = `Agora, pare a simula√ß√£o. Seu papel mudou. Voc√™ agora √© um coach de atendimento. Analise o di√°logo completo a seguir entre um atendente e um cliente. Forne√ßa uma avalia√ß√£o construtiva e detalhada sobre o desempenho do ATENDENTE. Avalie os seguintes pontos:\n1. **Empatia:** O atendente demonstrou empatia? Foi paciente?\n2. **Clareza:** A comunica√ß√£o foi clara e f√°cil de entender?\n3. **T√©cnica:** O atendente seguiu os procedimentos corretos para diagnosticar e resolver o problema?\n4. **Pontos a Melhorar:** D√™ sugest√µes espec√≠ficas de como o atendente poderia ter agido melhor em certas partes da conversa.\n\nFormate a resposta usando Markdown com t√≠tulos e negrito. Di√°logo:\n\n${JSON.stringify(conversationHistory)}`;
                try {
                    const feedback = await callGemini(feedbackPrompt);
                    feedbackResults.innerHTML = parseSimpleMarkdown(feedback);
                    simChatView.style.display = 'none';
                    simFeedbackView.style.display = 'block';
                } catch (error) {
                    console.error("Error getting feedback:", error);
                    feedbackResults.innerHTML = "Desculpe, ocorreu um erro ao gerar a avalia√ß√£o. Por favor, tente finalizar novamente.";
                } finally {
                    simLoader.style.display = 'none';
                }
            }
            
            if (startSimBtn) startSimBtn.addEventListener('click', startSimulation);
            if (sendChatBtn) sendChatBtn.addEventListener('click', sendChatMessage);
            if (chatInput) chatInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') sendChatMessage(); });
            if (endSimBtn) endSimBtn.addEventListener('click', endSimulation);
            if (restartSimBtn) restartSimBtn.addEventListener('click', () => {
                simChatView.style.display = 'none';
                simFeedbackView.style.display = 'none';
                simSetupView.style.display = 'block';
            });

            // Gerador de Relat√≥rio
            const generateReportBtn = document.getElementById('generateReportBtn');
            const reportSummary = document.getElementById('reportSummary');
            const reportLoader = document.getElementById('report-loader');
            const reportResults = document.getElementById('report-results');
            const reportOutput = document.getElementById('report-output');
            const copyReportBtn = document.getElementById('copyReportBtn');
            
            if (generateReportBtn) {
                generateReportBtn.addEventListener('click', async () => {
                    if (!reportSummary.value.trim()) { reportSummary.focus(); return; }
                    reportLoader.style.display = 'block';
                    reportResults.classList.add('hidden');
                    generateReportBtn.disabled = true;
                    const prompt = `Voc√™ √© um assistente para atendentes de suporte t√©cnico da IRED. Sua tarefa √© converter um resumo informal de um atendimento em um relat√≥rio t√©cnico formal e bem-estruturado para ser inserido no sistema de tickets. O relat√≥rio deve ser claro, conciso e usar terminologia t√©cnica apropriada (ex: "verificado sinal √≥ptico", "ajustado canal da rede Wi-Fi", "cliente orientado a reiniciar equipamentos"). Estruture o relat√≥rio com as se√ß√µes: "Relato do Cliente:", "Procedimentos Realizados:" e "Conclus√£o:".\n\nResumo do atendente: "${reportSummary.value}"`;
                    try {
                        const formalReport = await callGemini(prompt);
                        reportOutput.value = formalReport.replace(/<br>/g, '\n');
                        reportResults.classList.remove('hidden');
                    } catch (error) {
                        console.error("Error generating report:", error);
                        reportOutput.value = "Desculpe, ocorreu um erro ao gerar o relat√≥rio. Tente novamente.";
                        reportResults.classList.remove('hidden');
                    } finally {
                        reportLoader.style.display = 'none';
                        generateReportBtn.disabled = false;
                    }
                });
            }

            if (copyReportBtn) {
                copyReportBtn.addEventListener('click', () => {
                    reportOutput.select();
                    document.execCommand('copy');
                    const copyBtnText = document.getElementById('copyBtnText');
                    copyBtnText.textContent = 'Copiado!';
                    copyReportBtn.classList.add('bg-green-700');
                    setTimeout(() => {
                        copyBtnText.textContent = 'Copiar Relat√≥rio';
                        copyReportBtn.classList.remove('bg-green-700');
                    }, 2000);
                });
            }

            // --- Base de Conhecimento ---
            const manualContent = [
                { title: 'Conector da Fibra', content: `A ponta do conector √© <strong>extremamente sens√≠vel</strong> a poeira, gordura e arranh√µes. Existem dois tipos: Verde (APC) e Azul (UPC). Nosso padr√£o √© o Verde. <strong>NUNCA</strong> instrua o cliente a desconect√°-lo.` },
                { title: 'ONU (Optical Network Unit)', content: `A ONU converte o sinal de luz da fibra para sinal el√©trico. Luzes importantes:<ul><li><strong>POWER:</strong> Acesa e est√°vel (OK).</li><li><strong>PON:</strong> Acesa e est√°vel (Sinal da fibra OK).</li><li><strong>LOS:</strong> Apagada (OK). Se estiver acesa ou piscando, h√° perda de sinal e uma O.S. deve ser agendada.</li><li><strong>LAN:</strong> Piscando (Comunicando com roteador).</li></ul>` },
                { title: 'Cabo de Rede (RJ45)', content: `Pode limitar a velocidade. Verifique a categoria:<ul><li><strong>CAT 5:</strong> Limita a rede em 100 Mbps.</li><li><strong>CAT 5e (ou superior):</strong> Suporta 1 Gbps ou mais. Essencial para planos acima de 100 Mega.</li></ul>` },
                { title: 'Diagn√≥stico de Lentid√£o', content: `Primeiro, pe√ßa um teste no fast.com ou speedtest.net. Lembre-se que a velocidade garantida s√≥ √© v√°lida via cabo de rede (CAT 5e+) em um dispositivo compat√≠vel. Fatores que limitam a velocidade: cabo de rede antigo, rede Wi-Fi (2.4GHz √© mais lenta que 5GHz) e capacidade do dispositivo do cliente.` },
                { title: 'Diagn√≥stico de Wi-Fi', content: `Causas comuns para sinal fraco s√£o barreiras f√≠sicas (paredes, lajes, espelhos, aqu√°rios) e interfer√™ncia de outros eletr√¥nicos (micro-ondas, telefones sem fio, Wi-Fi de vizinhos). Use o app WiFiMan para medir o sinal (dBm) nos c√¥modos. Quanto mais perto de 0, melhor. Sinal abaixo de -70 dBm √© considerado ruim.` },
            ];

            const manualContainer = document.getElementById('manual-content');
            manualContent.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card p-6';
                card.innerHTML = `<h3>${item.title}</h3><div class="mt-4 text-gray-600">${item.content}</div>`;
                manualContainer.appendChild(card);
            });

             // --- Central API Call Function ---
            async function callGemini(prompt) {
                return callGeminiWithHistory([{ role: "user", parts: [{ text: prompt }] }]);
            }
            
            async function callGeminiWithHistory(history) {
                 const apiEndpoint = '/.netlify/functions/gemini';
                 const response = await fetch(apiEndpoint, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ history: history })
                 });
                 if (!response.ok) { 
                     const errorText = await response.text();
                     throw new Error(`API call failed: ${response.status} - ${errorText}`);
                 }
                 const result = await response.json();
                 if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                     return result.candidates[0].content.parts[0].text;
                 } else {
                     console.error("Unexpected API response structure:", result);
                     if (result.promptFeedback && result.promptFeedback.blockReason) {
                         return `N√£o foi poss√≠vel gerar uma resposta. Motivo: ${result.promptFeedback.blockReason}`;
                     }
                     return "N√£o foi poss√≠vel gerar uma resposta. A estrutura do retorno da API √© inesperada.";
                 }
            }

            function parseSimpleMarkdown(text) {
                if (!text) return '';
                // Bolding: **text** or *text*
                let newText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Italics: *text*
                newText = newText.replace(/\*(.*?)\*/g, '<em>$1</em>');
                // Newlines
                newText = newText.replace(/\n/g, '<br>');
                // Lists
                newText = newText.replace(/(\d+\.\s.*?(?=\n\d+\.|$))/g, '<li>$1</li>');
                if (newText.includes('<li>')) {
                    newText = '<ol class="list-decimal pl-5">' + newText + '</ol>';
                }
                return newText;
            }
        });
    </script>
</body>
</html>
